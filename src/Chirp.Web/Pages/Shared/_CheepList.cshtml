@using Chirp.Web
@using Chirp.Core.Entities
@using Chirp.Core.Repository
@using Chirp.Infrastructure.Repository
@inject SignInManager<Author> SigninManager
@inject UserManager<Author> UserManager
@inject IAuthorRepository AuthorRepository
@inject IReactionRepository ReactionRepository
@model dynamic


<ul id="messagelist" class="cheeps">
    @foreach (CheepViewModel cheep in Model.Cheeps)
    {
        <li>
            <div class="cheep-view">
                <div class="cheep-info">
                    <strong>
                        <a href="/@cheep.Author">@cheep.Author</a>
                        <p>Followers: @AuthorRepository.GetAuthorByName(cheep.Author).Followers.Count</p>
                    </strong>
                    <p class="cheep-message">
                        @cheep.Message
                    </p>

                    <small>&mdash; @cheep.Timestamp</small>
                </div>
                <div class="reaction-box">
                    @if (SigninManager.IsSignedIn(User))
                    {
                        // Draft on multiple reactions 
                        @* @foreach (var reaction in @cheep.Reactions) *@
                        @* { *@
                        @*     @if (reaction.AuthorIds.Contains(UserManager.GetUserAsync(User).Result!.Id)) *@
                        @*     { *@
                        @*         <form asp-page="public" asp-page-handler="RemoveReaction" method="post" asp-route-cheepId="@cheep.CheepId" asp-route-reaction="@reaction.ReactionType"> *@
                        @*             <input class="reacted" type="submit" id="reactionId" name="ReactionIdInput" value="@reaction.ReactionType: @reaction.Count"/> *@
                        @*         </form> *@
                        @*     } *@
                        @*     else *@
                        @*     { *@
                        @*         <form asp-page="public" asp-page-handler="Reaction" method="post" asp-route-cheepId="@cheep.CheepId" asp-route-reaction="@reaction.ReactionType"> *@
                        @*             <input type="submit" id="reactionId" name="ReactionIdInput" value="@reaction.ReactionType: @reaction.Count"/> *@
                        @*         </form> *@
                        @*     } *@
                        @* } *@
                        
                         @if (ReactionRepository.HasUserReacted(@cheep.CheepId, UserManager.GetUserAsync(User).Result!.Id).Result) 
                             { 
                               <form asp-page="public" asp-page-handler="RemoveReaction" method="post" asp-route-cheepId="@cheep.CheepId" asp-route-reaction="@cheep.Reactions.First().ReactionType"> 
                                     <input class="reacted" type="submit" id="reactionId" name="ReactionIdInput" value="Like: @cheep.Reactions.First().Count"/> 
                                </form> 
                            } else 
                            { 
                                <form asp-page="public" asp-page-handler="Reaction" method="post" asp-route-cheepId="@cheep.CheepId" asp-route-reaction="@cheep.Reactions.First().ReactionType"> 
                                     <input type="submit" id="reactionId" name="ReactionIdInput" value="Like: @cheep.Reactions.First().Count"/> 
                                 </form> 
                             } 
                    }
                    else
                    {
                        @foreach (var reaction in cheep.Reactions)
                        {
                            <u class="reactions-display">@reaction.ReactionType: @reaction.Count</u>
                        }
                    }
                </div>

                @if (SigninManager.IsSignedIn(User) || cheep.Author == User.Identity?.Name){
                    if (!Model.user.Following.Contains(await AuthorRepository.GetAuthorByIdAsync(cheep.AuthorId))) {
                        <form asp-page-handler="Follow" method="post">
                            <input type="hidden" id="author2FollowId" name="Author2FollowInput" value="@cheep.AuthorId.ToString()" />
                            <input type="submit" value="Follow" />
                        </form>
                    } else {
                        <form asp-page-handler="Unfollow" method="post">
                            <input type="hidden" id="author2UnfollowId" name="Author2UnfollowInput" value="@cheep.AuthorId.ToString()" />
                            <input type="submit" value="Unfollow" />
                        </form>
                    }
                }
            </div>
        </li>
    }
</ul>